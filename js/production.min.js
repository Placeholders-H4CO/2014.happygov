function getFeatures(){var a=new esri.tasks.Query;a.geometry=map.extent,a.where="1=1",a.outSpatialReference=map.spatialReference,featureLayer.queryFeatures(a,function(a){var b=[];a&&a.features&&a.features.length>0&&(b=a.features),heatLayer.setData(b)})}function init(){function a(a){var b=a.attributes.Votes;null===b&&(b=0);{var c=a.attributes.Neighborhood,d=a.attributes.Case_Summary,e=a.attributes.Case_Status;a.attributes.Case_Created_Date}if(c)var f="<b>"+d+"</b> <br> Status: "+e+" <br> Opened:  <br>Neighborhood: "+c+"<p>";else var f="<b>"+d+"</b> <br> Status: "+e+" <br> Opened: <p>";return f=f+"<br><br><span class='genericon genericon-digg' onclick='javascript:voteOnIncident();'></span> <span class='voteCount'>"+b+"</span></p>",voteOnIncident=function(){a.attributes.Votes=Number(b)+1,jQuery(".voteCount").text(a.attributes.Votes),featureLayer.applyEdits(null,[a],null)},f}var b=new esri.geometry.Extent({xmax:-11658645.465148315,xmin:-11713680.125513569,ymax:4843249.550527445,ymin:4813095.142868984,spatialReference:{wkid:102100}});map=new esri.Map("map",{extent:b,sliderStyle:"small"}),require(["esri/dijit/LocateButton","dojo/dom","dojo/dom-construct","myModules/InfoWindow","dojo/string","dojo/domReady!"],function(a,b,c,d){new d({domNode:c.create("div",null,b.byId("map"))});geoLocate=new a({map:map},"LocateButton"),geoLocate.startup()});var c=new esri.InfoTemplate;c.setTitle("<b>${Type}</b>"),c.setContent(a);var d=new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");map.addLayer(d),dojo.connect(map,"onLoad",function(){dojo.connect(dijit.byId("map"),"resize",map,map.resize),heatLayer=new HeatmapLayer({config:{useLocalMaximum:!0,radius:40,gradient:{.45:"rgb(52,152,219)",.55:"rgb(41,128,185)",.65:"rgb(46,204,113)",.75:"rgb(29,160,82)",.85:"rgb(255,206,0)",.95:"rgb(243,156,118)",1:"rgb(231,76,60)"}},map:map,domNodeId:"heatLayer",opacity:.85}),map.addLayer(heatLayer),map.resize(),featureLayer=new esri.layers.FeatureLayer("http://services2.arcgis.com/apfHT0xk4Qw2A1dv/arcgis/rest/services/311_service_requests_2014/FeatureServer/0",{mode:esri.layers.FeatureLayer.MODE_ONDEMAND,visible:!1,infoTemplate:c,outFields:["*"]}),map.addLayer(featureLayer),map.infoWindow.resize(300,200),getFeatures(),dojo.connect(map,"onExtentChange",getFeatures),dojo.connect(dojo.byId("tog"),"onclick",function(){heatLayer.visible?heatLayer.hide():heatLayer.show()}),dojo.connect(dojo.byId("tog2"),"onclick",function(){featureLayer.visible?(featureLayer.hide(),jQuery("#typeBox").hide()):(featureLayer.show(),jQuery("#typeBox").show())})})}function resizeDiv(){vpw=$(window).width(),vph=$(window).height(),mapOffset=$("#main").offset().top,footerH=$("footer").height(),$("#main").css({height:vph/1.6+"px"}),$("#main #map").css({height:vph/1.6+"px"})}dojo.addOnLoad(function(){dojo.declare("HeatmapLayer",[esri.layers.DynamicMapServiceLayer],{properties:{},heatMap:null,constructor:function(a){dojo.safeMixin(this.properties,a),this._map=this.properties.map,this.lastData=[],this.domNode=document.getElementById(this.properties.domNodeId),this.config={element:this.domNode,width:this._map.width,height:this._map.height,radius:40,debug:!1,visible:!0,useLocalMaximum:!1,gradient:{.45:"rgb(000,000,255)",.55:"rgb(000,255,255)",.65:"rgb(000,255,000)",.95:"rgb(255,255,000)",1:"rgb(255,000,000)"}},dojo.safeMixin(this.config,a.config),this.heatMap=heatmapFactory.create(this.config),this.loaded=!0,this.onLoad(this),this.globalMax=0,dojo.connect(this._map,"onResize",this,this.resizeHeatmap),this.domNode.style.position="relative",this.domNode.style.display="none"},resizeHeatmap:function(a,b,c){this.heatMap.set("width",b),this.heatMap.set("height",c),dojo.style(this.domNode,{width:b+"px",height:c+"px"});var d=dojo.query(":first-child",this.domNode);d&&(d.attr("width",b),d.attr("height",c));var e=this.heatMap.get("actx");e.canvas.height=c,e.canvas.width=b,this.heatMap.set("actx",e),this.refresh()},storeHeatmapData:function(a){this.heatMap.store.setDataSet(a)},convertHeatmapData:function(a){var b,c,d,e;if(d={max:a.max,data:[]},a.data)for(b in a.data)if(a.data.hasOwnProperty(b))for(c in a.data[b])a.data[b].hasOwnProperty(c)&&(e=esri.geometry.toScreenGeometry(this._map.extent,this._map.width,this._map.height,a.data[b][c].dataPoint),d.data.push({x:e.x,y:e.y,count:a.data[b][c].count}));this.storeHeatmapData(d)},parseHeatmapData:function(a){var b,c,d,e;if(a){for(c={max:0,data:[]},this.config.useLocalMaximum||(c.max=this.globalMax),b=0;b<a.length;b++){d=esri.geometry.Point(a[b].geometry);var f=!1;this.config.useLocalMaximum?this._map.extent.contains(d)&&(f=!0):f=!0,f&&(e=a[b].attributes,c.data[d.x]||(c.data[d.x]=[]),c.data[d.x][d.y]||(c.data[d.x][d.y]={},c.data[d.x][d.y].count=e&&e.hasOwnProperty("count")?e.count:0),c.data[d.x][d.y].count+=1,c.data[d.x][d.y].dataPoint=d,c.max<c.data[d.x][d.y].count&&(c.max=c.data[d.x][d.y].count,this.config.useLocalMaximum||(this.globalMax=c.data[d.x][d.y].count)))}this.convertHeatmapData(c)}},setData:function(a){this.resizeHeatmap(null,this._map.width,this._map.height),this.lastData=a,this.parseHeatmapData(a),this.refresh()},addDataPoint:function(a){a&&(this.lastData.push(a),setData(this.lastData))},exportDataSet:function(){return this.lastData},clearData:function(){this.heatMap.clear();var a=[];this.setData(a)},getImageUrl:function(a,b,c,d){this.parseHeatmapData(this.lastData);var e=this.heatMap.get("canvas").toDataURL("image/png");d(e)}})}),function(a){var b=function(){var a=function(a){var b={data:[],heatmap:a};this.max=1,this.get=function(a){return b[a]},this.set=function(a,c){b[a]=c}};a.prototype={addDataPoint:function(a,b){if(!(0>a||0>b)){var c=this,d=c.get("heatmap"),e=c.get("data");return e[a]||(e[a]=[]),e[a][b]||(e[a][b]=0),e[a][b]+=arguments.length<3?1:arguments[2],c.set("data",e),c.max<e[a][b]?(d.get("actx").clearRect(0,0,d.get("width"),d.get("height")),void c.setDataSet({max:e[a][b],data:e},!0)):void d.drawAlpha(a,b,e[a][b],!0)}},setDataSet:function(a,b){var c=this,d=c.get("heatmap"),e=[],f=a.data,g=f.length;if(d.clear(),this.max=a.max,d.get("legend")&&d.get("legend").update(a.max),null!=b&&b){for(var h in f)if(void 0!==h)for(var i in f[h])void 0!==i&&d.drawAlpha(h,i,f[h][i],!1)}else for(;g--;){var j=f[g];d.drawAlpha(j.x,j.y,j.count,!1),e[j.x]||(e[j.x]=[]),e[j.x][j.y]||(e[j.x][j.y]=0),e[j.x][j.y]=j.count}d.colorize(),this.set("data",f)},exportDataSet:function(){var a=this,b=a.get("data"),c=[];for(var d in b)if(void 0!==d)for(var e in b[d])void 0!==e&&c.push({x:parseInt(d,10),y:parseInt(e,10),count:b[d][e]});return{max:a.max,data:c}},generateRandomDataSet:function(a){var b=this.get("heatmap"),c=b.get("width"),d=b.get("height"),e={},f=Math.floor(1e3*Math.random()+1);e.max=f;for(var g=[];a--;)g.push({x:Math.floor(Math.random()*c+1),y:Math.floor(Math.random()*d+1),count:Math.floor(Math.random()*f+1)});e.data=g,this.setDataSet(e)}};var b=function(a){this.config=a;var b={element:null,labelsEl:null,gradientCfg:null,ctx:null};this.get=function(a){return b[a]},this.set=function(a,c){b[a]=c},this.init()};b.prototype={init:function(){var a,b,c=this,d=c.config,e=d.title||"Legend",f=d.position,g=d.offset||10,h=(d.gradient,document.createElement("ul")),i="";c.processGradientObject(),i+=f.indexOf("t")>-1?"top:"+g+"px;":"bottom:"+g+"px;",i+=f.indexOf("l")>-1?"left:"+g+"px;":"right:"+g+"px;",a=document.createElement("div"),a.style.cssText="border-radius:5px;position:absolute;"+i+"font-family:Helvetica; width:256px;z-index:10000000000; background:rgba(255,255,255,1);padding:10px;border:1px solid black;margin:0;",a.innerHTML="<h3 style='padding:0;margin:0;text-align:center;font-size:16px;'>"+e+"</h3>",h.style.cssText="position:relative;font-size:12px;display:block;list-style:none;list-style-type:none;margin:0;height:15px;",b=document.createElement("div"),b.style.cssText=["position:relative;display:block;width:256px;height:15px;border-bottom:1px solid black; background-image:url(",c.createGradientImage(),");"].join(""),a.appendChild(h),a.appendChild(b),c.set("element",a),c.set("labelsEl",h),c.update(1)},processGradientObject:function(){var a=this,b=this.config.gradient,c=[];for(var d in b)b.hasOwnProperty(d)&&c.push({stop:d,value:b[d]});c.sort(function(a,b){return a.stop-b.stop}),c.unshift({stop:0,value:"rgba(0,0,0,0)"}),a.set("gradientArr",c)},createGradientImage:function(){var a,b=this,c=b.get("gradientArr"),d=c.length,e=document.createElement("canvas"),f=e.getContext("2d");e.width="256",e.height="15",a=f.createLinearGradient(0,5,256,10);for(var g=0;d>g;g++)a.addColorStop(1/(d-1)*g,c[g].value);f.fillStyle=a,f.fillRect(0,5,256,10),f.strokeStyle="black",f.beginPath();for(var g=0;d>g;g++)f.moveTo((1/(d-1)*g*256>>0)+.5,0),f.lineTo((1/(d-1)*g*256>>0)+.5,0==g?15:5);return f.moveTo(255.5,0),f.lineTo(255.5,15),f.moveTo(255.5,4.5),f.lineTo(0,4.5),f.stroke(),b.set("ctx",f),e.toDataURL()},getElement:function(){return this.get("element")},update:function(a){for(var b,c,d=this,e=d.get("gradientArr"),f=d.get("ctx"),g=d.get("labelsEl"),h="",i=0;i<e.length;i++)b=a*e[i].stop>>0,c=f.measureText(b).width/2>>0,0==i&&(c=0),i==e.length-1&&(c*=2),h+='<li style="position:absolute;left:'+(((1/(e.length-1)*i*256||0)>>0)-c+.5)+'px">'+b+"</li>";g.innerHTML=h}};var c=function(b){var c={radius:40,element:{},canvas:{},acanvas:{},ctx:{},actx:{},legend:null,visible:!0,width:0,height:0,max:!1,gradient:!1,opacity:180,premultiplyAlpha:!1,bounds:{l:1e3,r:0,t:1e3,b:0},debug:!1};this.store=new a(this),this.get=function(a){return c[a]},this.set=function(a,b){c[a]=b},this.configure(b),this.init()};return c.prototype={configure:function(a){var c=this;if(c.set("radius",a.radius||40),c.set("element",a.element instanceof Object?a.element:document.getElementById(a.element)),c.set("visible",null!=a.visible?a.visible:!0),c.set("max",a.max||!1),c.set("gradient",a.gradient||{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}),c.set("opacity",parseInt(255/(100/a.opacity),10)||180),c.set("width",a.width||0),c.set("height",a.height||0),c.set("debug",a.debug),a.legend){var d=a.legend;d.gradient=c.get("gradient"),c.set("legend",new b(d))}},resize:function(){var a=this.get("element"),b=this.get("canvas"),c=this.get("acanvas");b.width=c.width=a.style.width.replace(/px/,"")||this.getWidth(a),this.set("width",b.width),b.height=c.height=a.style.height.replace(/px/,"")||this.getHeight(a),this.set("height",b.height)},init:function(){var a=this,b=document.createElement("canvas"),c=document.createElement("canvas"),d=b.getContext("2d"),e=c.getContext("2d"),f=a.get("element");a.initColorPalette(),a.set("canvas",b),a.set("ctx",d),a.set("acanvas",c),a.set("actx",e),a.resize(),b.style.cssText=c.style.cssText="position:absolute;top:0;left:0;z-index:10000000;",a.get("visible")||(b.style.display="none"),f.appendChild(b),a.get("legend")&&f.appendChild(a.get("legend").getElement()),a.get("debug")&&document.body.appendChild(c),e.shadowOffsetX=1e3,e.shadowOffsetY=1e3,e.shadowBlur=15},initColorPalette:function(){var a,b,c,d=this,e=document.createElement("canvas"),f=d.get("gradient");e.width="1",e.height="256",a=e.getContext("2d"),b=a.createLinearGradient(0,0,1,256),c=a.getImageData(0,0,1,1),c.data[0]=c.data[3]=64,c.data[1]=c.data[2]=0,a.putImageData(c,0,0),c=a.getImageData(0,0,1,1),d.set("premultiplyAlpha",c.data[0]<60||c.data[0]>70);for(var g in f)b.addColorStop(g,f[g]);a.fillStyle=b,a.fillRect(0,0,1,256),d.set("gradient",a.getImageData(0,0,1,256).data)},getWidth:function(a){var b=a.offsetWidth;return a.style.paddingLeft&&(b+=a.style.paddingLeft),a.style.paddingRight&&(b+=a.style.paddingRight),b},getHeight:function(a){var b=a.offsetHeight;return a.style.paddingTop&&(b+=a.style.paddingTop),a.style.paddingBottom&&(b+=a.style.paddingBottom),b},colorize:function(a,b){var c,d,e,f,g,h,i,j,k,l,m=this,n=m.get("width"),o=m.get("radius"),p=m.get("height"),q=m.get("actx"),r=m.get("ctx"),s=3*o,t=m.get("premultiplyAlpha"),u=m.get("gradient"),v=m.get("opacity"),w=m.get("bounds");null!=a&&null!=b?(a+s>n&&(a=n-s),0>a&&(a=0),0>b&&(b=0),b+s>p&&(b=p-s),c=a,d=b,f=a+s,e=b+s):(c=w.l<0?0:w.l,f=w.r>n?n:w.r,d=w.t<0?0:w.t,e=w.b>p?p:w.b),g=q.getImageData(c,d,f-c,e-d),h=g.data,i=h.length;for(var x=3;i>x;x+=4)j=h[x],k=4*j,k&&(l=v>j?j:v,h[x-3]=u[k],h[x-2]=u[k+1],h[x-1]=u[k+2],t&&(h[x-3]/=255/l,h[x-2]/=255/l,h[x-1]/=255/l),h[x]=l);g.data=h,r.putImageData(g,c,d)},drawAlpha:function(a,b,c,d){var e=this,f=e.get("radius"),g=e.get("actx"),h=(e.get("max"),e.get("bounds")),i=a-1.5*f>>0,j=b-1.5*f>>0,k=a+1.5*f>>0,l=b+1.5*f>>0;g.shadowColor="rgba(0,0,0,"+(c?c/e.store.max:"0.1")+")",g.shadowOffsetX=1e3,g.shadowOffsetY=1e3,g.shadowBlur=15,g.beginPath(),g.arc(a-1e3,b-1e3,f,0,2*Math.PI,!0),g.closePath(),g.fill(),d?e.colorize(i,j):(i<h.l&&(h.l=i),j<h.t&&(h.t=j),k>h.r&&(h.r=k),l>h.b&&(h.b=l))},toggleDisplay:function(){var a=this,b=a.get("visible"),c=a.get("canvas");c.style.display=b?"none":"block",a.set("visible",!b)},getImageData:function(){return this.get("canvas").toDataURL()},clear:function(){var a=this,b=a.get("width"),c=a.get("height");a.store.set("data",[]),a.get("ctx").clearRect(0,0,b,c),a.get("actx").clearRect(0,0,b,c)},cleanup:function(){var a=this;a.get("element").removeChild(a.get("canvas"))}},{create:function(a){return new c(a)},util:{mousePosition:function(a){var b,c;return a.layerX?(b=a.layerX,c=a.layerY):a.offsetX&&(b=a.offsetX,c=a.offsetY),"undefined"!=typeof b?[b,c]:void 0}}}}();a.h337=a.heatmapFactory=b}(window),dojo.require("esri.map"),dojo.require("esri.layers.FeatureLayer"),dojo.require("esri.InfoTemplate");var map,heatLayer,featureLayer;dojo.addOnLoad(init),$(document).ready(function(){resizeDiv()}),window.onresize=function(){resizeDiv()},$("#mapToggle").click(function(){$("#listToggle").removeClass("active"),$("#list").removeClass("active"),$(this).addClass("active"),$("#main").addClass("active")}),$("#listToggle").click(function(){$("#mapToggle").removeClass("active"),$("#main").removeClass("active"),$(this).addClass("active"),$("#list").addClass("active")}),$("#tog").click(function(){$(this).toggleClass("active")}),$("#tog2").click(function(){$(this).toggleClass("active")}),$("#signup-toggle").click(function(){$("#mc_embed_signup").addClass("active")}),$("#form-close").click(function(){$("#mc_embed_signup").removeClass("active")}),$("#infoToggle").click(function(){$("#configArea").toggleClass("hide"),$(this).toggleClass("hide")});